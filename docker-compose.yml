services:
  postgres:
    image: postgres:17.7-alpine3.23
    container_name: nifi_database
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    command:
      - "postgres"
      - "-c"
      - "wal_level=logical"
      - "-c"
      - "max_replication_slots=4"
      - "-c"
      - "max_wal_senders=4"

  nifi:
    image: apache/nifi:2.7.2
    container_name: nifi_cdc
    ports:
      - "8443:8443"
    environment:
      - SINGLE_USER_CREDENTIALS_USERNAME=${NIFI_SINGLE_USER_CREDENTIALS_USERNAME}
      - SINGLE_USER_CREDENTIALS_PASSWORD=${NIFI_SINGLE_USER_CREDENTIALS_PASSWORD}
      - NIFI_WEB_HTTPS_PORT=8443
    volumes:
      - nifi_state:/opt/nifi/nifi-current/state
      - nifi_conf:/opt/nifi/nifi-current/conf
      - nifi_logs:/opt/nifi/nifi-current/logs
      # Mount the PostgreSQL JDBC driver directly
      - ./jdbc-driver/postgresql-42.7.1.jar:/opt/nifi/nifi-current/lib/postgresql-42.7.1.jar
    depends_on:
      - postgres

volumes:
  postgres_data:
  nifi_state:
  nifi_conf:
  nifi_logs: